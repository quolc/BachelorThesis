% 共通で使用できるAndroid用ライブラリを作成した
% ライブラリは次のようなアルゴリズムを使用している
In the system of AnnoTone, watermark signals are generated and transmitted from a smartphone.
We implemented a software library that provides essential functions for watermarking using following algorithm. % that can be used to create android applications for AnnoTone 

% 入力データに対してどのように処理を行うか
% annotation -> byte array -> packet -> wave data
% 位相変化時の低周波成分ノイズ発生を抑えるために窓関数を掛ける
First, an annotation of any kind of data (e.g. GPS position, a situation of ball game) is serialized to a payload, an array of 4-bits data following the arrangement manner mentioned in the previous chapter.
Secondly, a data stream of a packet is generated from the payload by calculating CRC-8 checksum.
Thirdly, DTMF-modulated pcm wave is generated using following formulae.

$s(t, m)$ is the sample value of the m-th sub-carrier at timestamp $t$ (s) counted from the beginning of the wave. $f(m)$ is the frequency (Hz) of the m-th sub-carrier and $d(n)$ is the n-th 4-bits data of the payload.

\begin{align}
s(t, m) = w( 0.5 \cdot a(m, d(\lfloor \frac{t}{0.01} \rfloor)) \cdot \sin{(2 \pi t \cdot f(m))} )
\end{align}

$a(m, x)$ is DTMF encoding function defined as the $(m, x)$-th element of below table.
(Blank means zero)

\begin{table}[ht]
\begin{center}
	\begin{tabular}{|c||c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|} \hline
		  & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & A & B & C & D & E & F \\ \hline \hline
		7 &   &   &   &   &   & 1 &   &   &   &   & 1 &   &   &   & 1 &   \\ \hline
		6 &   &   &   &   & 1 &   &   &   &   & 1 &   &   &   & 1 &   &   \\ \hline
		5 &   &   &   & 1 &   &   &   &   & 1 &   &   &   & 1 &   &   & 1 \\ \hline
		4 &   &   & 1 &   &   &   &   & 1 &   &   &   & 1 &   &   &   & 1 \\ \hline
		3 &   & 1 &   &   &   &   & 1 &   &   &   &   & 1 & 1 & 1 & 1 &   \\ \hline
		2 & 1 &   &   &   &   &   & 1 & 1 & 1 & 1 & 1 &   &   &   &   &   \\ \hline
		1 & 1 & 1 & 1 & 1 & 1 & 1 &   &   &   &   &   &   &   &   &   &   \\ \hline
	\end{tabular}
\end{center}
\end{table}

$w(x, t)$ is an envelope filtering function to reduce the occurrence of low frequency noise at borders between two data frames.

\begin{align}
w(x, t) &= (0.5 - 0.5\cos{( 2 \pi \frac{t \bmod 0.01}{0.01} )}) ^{0.8}
\end{align}

Finally, watermark signal $x(t)$ to transmit is generated by mixing all sub-carrier signals as $ x(t) = \sum^{7}_{m=1} s(t, m) $.
